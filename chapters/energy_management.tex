\section{Energy management}\label{em}
With the introduction of smart grids, energy can be generated and distributed more efficiently by different kinds of \acp{der}. 
In contradiction to the current energy distribution systems, it doesn't matter if these \acp{der} are small, big, stable or unstable, they can all be connected to the smart grid. This gives new opportunities but also new challenges.
There has been done a lot of research into the energy management in smart grids, utilising game theory\cite{WangOuyangKrishnanEtAl2015, TusharZhangSmithEtAl2013}. Most of these papers don't seem to take into account the size of a smart grid, or try to model all aspects of energy management using one game theoretic approach. We instead consider three main fields in energy management: energy generation, energy storage and energy transport. This chapter discusses two promising concepts in these fields: \acp{vpp} and microgrids. 

\subsection{\aclp{vpp}}\label{vpp}
While individual \acp{der} have the option to sell (portions of) their produced energy to the grid, the number of \acp{der} in the network and their accompanying unreliability makes it hard to account for them in production schedules \cite{RobuKotaChalkiadakisEtAl2012}. It is essential that the grid's independent suppliers are reliable, since the failure to meet production targets could seriously compromise the smooth operation of the network as a whole \cite{ChalkiadakisRobuKotaEtAl2011}. \acp{vpp} can help solve this issue. The main concept of a \ac{vpp} illustrates a centralised control structure which connects, controls and visualises a work of these distributed generators \cite{NikonowiczMilewski2012}. Note that these generators can be both fossil and renewable energy sources \cite{LombardiPowalkoRudion2009}. The \ac{vpp} keeps track of its sources' supplies and is able to determine the price. 

\acp{vpp} can be very efficient, as they allow the combination of different energy sources to generate a continuous supply. In other words, resources with different weaknesses and strengths are combined in a complementary way \cite{Koeppel2003}. For example, when a wind turbine and solar cells are combined, the \ac{vpp} is less subject to changing weather conditions \cite{Tromly2001, Kumagai2012, MashhourMoghaddas-Tafreshi2011, NikonowiczMilewski2012}. 

A \ac{vpp} may use one of these approaches \cite{NikonowiczMilewski2012}:
\begin{itemize}
	\item Centralised control, where a single \ac{vpp} is responsible for the logic and management of \acp{der}, pricing and supply.
	\item Distributed control, where one or more local \acp{vpp} control a limited number of \acp{der} while delegating certain decisions upwards to a higher level \ac{vpp}.
	\item Fully distributed control, where each \ac{der} acts as an independent and intelligent agent.
\end{itemize}

Within the smart grid, the first approach is probably too simple, the resulting \ac{vpp} will become huge. Instead, it would be more feasible to use different \acp{vpp} with different targets, such as minimisation of generation costs and maximisation of profits \cite{LombardiPowalkoRudion2009}. The smart grid will then draw its energy from an aggregate of these \acp{vpp}, to deliver to its consumers. 

To coordinate production and pricing in a fully distributed \ac{vpp}, some form of agent cooperation is needed. To achieve this, mechanism design and cooperative game theory can be combined to derive a pricing mechanism, as well as ways to allocate revenues across agents and manage \ac{vpp} membership \cite{ChalkiadakisRobuKotaEtAl2011}. 

To make sure a \ac{vpp} is reliable, it should be able to announce a certain level of energy it will supply to a microgrid or smart grid. The main issue with this structure is that every \ac{vpp} needs to predict how much energy it is able to produce. Due to the fluctuating nature of renewable energy sources, the prediction of the energy production is not an easy procedure \cite{LombardiPowalkoRudion2009}.  

To get a better view of the energy production estimates within a group of individual \ac{der} agents, a pricing scheme may be introduced that encourages these agents to provide the \ac{vpp} with accurate estimates \cite{ChalkiadakisRobuKotaEtAl2011}. The proposed system not only encourages large \ac{vpp} sizes, but also promotes truthfulness by basing the payment on the accuracy of the supply prediction. This ensures that both \acp{vpp} and \acp{der} have no incentive to provide a wrong or biased estimate.

Furthermore, \cite{RobuKotaChalkiadakisEtAl2012} notes that a confidence interval is preferred over single point estimates, to remove the uncertainty of those estimates. It also proposes scoring rules, guaranteeing maximum reward if and only if a \ac{der} agent accurately reports its expectation over the prediction error it may make.  

\ac{vpp} membership poses another risk in a stable energy production. Should one or more individual \ac{der} agents managed by a \ac{vpp} decide to leave, the decrease in that \ac{vpp}'s production power may be significant. 

To ensure that the production of a \ac{vpp} remains relatively stable, a payoff scheme may be used that is based on the coalitional stability concept called the core. In short, a coalitional game with a subset of \acp{der} (the coalition) can be formed \cite{MihailescuVasiraniOssowski2011}. In this game, allocations of the maximum payoff can be determined to make sure agents do not break that coalition to improve their payoff even further\cite{ChalkiadakisRobuKotaEtAl2011, YeungPoonWu1999, SaadHanPoor2011}. Such an allocation belongs to the core of that game, and will ensure that a given set of \ac{der} agents will keep working together.

\subsection{Microgrids}\label{microgrids}
A microgrid is a group of interconnected users and distributed energy resources within clearly defined electrical boundaries that acts as a single controllable entity with respect to the grid \cit{ParhiziLotfiKhodaeiEtAl2015}. This means that all \acp{der} are aggregated into one power source for the whole microgrid \cite{KanchevLuColasEtAl2011}. A microgrid can connect and disconnect from the grid to enable it to operate in both grid-connected or island mode. For example when the grid has a surplus of energy it can deliver this to the rest of the grid and if its energy is in balance it disconnects. 

Due to the fact that microgrids are in essence smart grids with geographical limitations (although virtual microgrids also exist), it is logical to see that, when a microgrid is modelled using game theory, a game contains less players. As discussed in Chapter \ref{gametheory}, calculating Nash equilibria is almost as hard as calculating NP-hard problems. When making algorithms approximating the Nash equilibria, heuristics are definitely needed. Therefore, computing an approximation for such an equilibrium will cost relatively less computing power when done for microgrids. 

To get such a Nash equilibrium, a dynamic game can be used. In the microgrid model, this game may contain complete information, meaning that every players revenue function is common knowledge. In the game, all players are equipped with smart agents, and each smart agent determines its strategy and it is assumed that all players seek to maximise their revenue. By using a backwards-induction-outcome \fb{a what now?}, a Nash equilibrium can be calculated.\cite{MicrogridModellingPetrosAristidou}

Another advantage when using microgrids is the fact that they can help reduce energy loss. The loss of energy with big energy networks is mainly caused by two factors \cite{EnergyLossURL}: 

\begin{enumerate}
\item Energy transmission from power plants to local distributors is done trough power lines, which suffer from losses due to e.g. heat generation\cite{LasseterPaigi2004}.
\item In an energy grid, each transformer has a certain efficiency, which is never 100\%. Reducing the number of transformers will reduce overall energy loss.
\end{enumerate}

Microgrids will be able to reduce energy loss because generated power within microgrids can be used for local demand and can be traded with other nearby microgrids. It can also help to avoid the power losses found in a substation's transformer \cite{keypaper}.

Whenever some microgrids have an excess of power while others have a need for power, it might be beneficial for these microgrids (and their consumers) to exchange energy among each other instead of requesting it from the main grid \cite{SaadHanPoorEtAl2011}. To manage this, the same cooperative game theory concepts as discussed in \ref{vpp} can be used. When the power loss of a trade is mapped to the value of the corresponding coalition, that power loss can be minimised, contributing to the efficiency of the entire smart grid. 

The buying and selling of energy between microgrids can be guided by another cooperative game theory using auctions, as proposed in \cite{SaadHanPoorEtAl2011}. This involves matching several buyers and sellers within one or more coalition and agreeing on some price. This price $p$ can be obtained through the use of a \emph{double auction}, where all sellers asking $p$ or less and all buyers offering $p$ or more are matched and trade using $p$ \cite{gjerstad1998price}.

One of the challenges that arises in microgrids is the routing of energy. As mentioned before, it is beneficial to find an optimal routing schedule because this helps in fully utilising the distributed energy resources and decreases the cost of energy transmissions \cite{HongKim2016}. This routing task is, in a lot of ways, comparable to the traditional routing protocols. These traditional protocols often use cooperative game theory models to provide tools for analysing selfishness and complex interactions between network nodes \cite{PavlidouKoltsidas2008}.  These traditional protocols Energy routers for example exchange the energy information of each home in the data network and try to find the most effective transaction and effective transmission path in the energy network for energy sharing among homes. \cite{YoonKimChang2013} A big difference however is that the traditional routing protocols have a data plane, where in microgrids this is replaced for an energy plane.

Energy routing is already extensively researched and a lot of papers have been written on the topic. In \cite{BaghaieMoellerKrishnamachari2010} for example, a novel stochastic framework is introduced that uses distributed storage to challenge some of the (many) problems in current grids. For example: the difficulty in routing renewable sources owing to their stochastic and often volatile nature \cite{HongKim2016}. Problem with this approach is that the suggested stochastic game doesn't implement an effective transaction mechanism, including a pricing strategy. 

Another point of interest when designing energy routing protocols is security. In \cite{LinYuYangEtAl2012} for example, a simulation is done with a false data injection attack is executed against a distributed energy routing schedule. This resulted in a disrupted effectiveness of the energy distribution process, generating a significant loss in the energy supply and an increase in the distribution costs and power outages. In \cite{AhouraiTabandehJahedEtAl2009} a \ac{mas} game is introduced that results in a Nash-Stackelberg or a leader-followers game. An evolutionary algorithm is proposed to solve this game. In \cite{AhouraiTabandehJahedEtAl2009} simulations show that game theoretic approaches behave more fairly over other existing solutions.

The growing usage of \ac{ev}s offers a lot of possibilities for microgrids because it expands the storage capacity of a microgrid tremendously. One of the key challenges in integrating \ac{ev}s in a smart grid is modelling the interactions of all actors. In \cite{SaadHanPoorEtAl2011} a non-cooperative game is formulated between \ac{ev} groups where groups strategically choose how much of their energy surplus is sold. A double auction based mechanism is given to determine the energy price of the energy trade market, to assure a strategy-proof outcome. 